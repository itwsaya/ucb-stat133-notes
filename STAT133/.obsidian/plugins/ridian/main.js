/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var We=Object.create;var j=Object.defineProperty;var Oe=Object.getOwnPropertyDescriptor;var Ve=Object.getOwnPropertyNames;var Ue=Object.getPrototypeOf,je=Object.prototype.hasOwnProperty;var qe=(s,i)=>{for(var e in i)j(s,e,{get:i[e],enumerable:!0})},Ce=(s,i,e,t)=>{if(i&&typeof i=="object"||typeof i=="function")for(let n of Ve(i))!je.call(s,n)&&n!==e&&j(s,n,{get:()=>i[n],enumerable:!(t=Oe(i,n))||t.enumerable});return s};var L=(s,i,e)=>(e=s!=null?We(Ue(s)):{},Ce(i||!s||!s.__esModule?j(e,"default",{value:s,enumerable:!0}):e,s)),Qe=s=>Ce(j({},"__esModule",{value:!0}),s);var dt={};qe(dt,{default:()=>ht});module.exports=Qe(dt);var x=require("obsidian"),oe=L(require("fs")),re=L(require("os")),ae=L(require("path"));var R=require("obsidian"),q=class{constructor(i){this.plugin=i}onLoad(){this.addMenu(),this.plugin.registerEvent(this.plugin.app.workspace.on("active-leaf-change",()=>{this.addMenu()})),this.plugin.registerEvent(this.plugin.app.workspace.on("layout-change",()=>{this.addMenu()}))}onUnload(){this.menuContainer&&this.menuContainer.remove()}addMenu(){this.menuContainer&&this.menuContainer.remove();let i=this.plugin.app.workspace.getActiveViewOfType(R.MarkdownView);if(!i)return;let e=i.containerEl.querySelector(".cm-editor");if(!e)return;this.menuContainer=document.createElement("div"),this.menuContainer.className="floating-menu";let t=this.createIconButton("bold",()=>this.plugin.applyWrapping("**"),"Bold"),n=this.createIconButton("italic",()=>this.plugin.applyWrapping("_"),"Italic"),o=this.createIconButton("strikethrough",()=>this.plugin.applyWrapping("~~"),"Strikethrough"),r=this.createIconButton("underline",()=>this.plugin.applyHtmlTag("u"),"Underline"),l=this.createTextButton("align-left","",()=>this.plugin.applyAlignment("left"),"Left align"),a=this.createTextButton("align-center","",()=>this.plugin.applyAlignment("center"),"Center align"),c=this.createTextButton("align-right","",()=>this.plugin.applyAlignment("right"),"Right align"),p=this.createTextButton("align-justify","",()=>this.plugin.applyAlignment("justify"),"Justify"),h=this.createIconButton("heading-1",()=>this.plugin.applyHeading(1),"Heading 1"),u=this.createIconButton("heading-2",()=>this.plugin.applyHeading(2),"Heading 2"),g=this.createIconButton("heading-3",()=>this.plugin.applyHeading(3),"Heading 3"),m=this.createTextButton("code","Insert R",()=>this.plugin.insertCodeBlock("r"),"R code chunk"),y=this.createTextButton("play","Run chunk",()=>this.plugin.runCommand("run-current-code-chunk"),"Run current code chunk"),d=this.createTextButton("file-down","Render/Quarto",()=>this.plugin.runCommand("export-note-with-quarto"),"Export note with Quarto");y.classList.add("glow-on-hover"),d.classList.add("glow-on-hover"),m.classList.add("glow-on-hover"),this.menuContainer.appendChild(t),this.menuContainer.appendChild(n),this.menuContainer.appendChild(o),this.menuContainer.appendChild(r),this.menuContainer.appendChild(l),this.menuContainer.appendChild(a),this.menuContainer.appendChild(c),this.menuContainer.appendChild(p),this.menuContainer.appendChild(h),this.menuContainer.appendChild(u),this.menuContainer.appendChild(g),this.menuContainer.appendChild(m),this.menuContainer.appendChild(y),this.menuContainer.appendChild(d),e.parentElement&&e.parentElement.insertBefore(this.menuContainer,e),e.style.marginTop=`${this.menuContainer.offsetHeight}px`}createIconButton(i,e,t){let n=document.createElement("button");return n.className="floating-menu-button",(0,R.setIcon)(n,i),t&&((0,R.setTooltip)(n,t),n.setAttribute("title",t)),n.addEventListener("click",e),n}createTextButton(i,e,t,n){let o=document.createElement("button");o.className="floating-menu-button floating-menu-button-text";let r=document.createElement("span");(0,R.setIcon)(r,i),r.className="button-icon";let l=document.createElement("span");return l.textContent=e,l.className="button-text",o.appendChild(r),o.appendChild(l),n&&((0,R.setTooltip)(o,n),o.setAttribute("title",n)),o.addEventListener("click",t),o}};var Ee=require("obsidian"),N="r-environment-view",Q=class extends Ee.ItemView{constructor(e){super(e);this.environmentData=[];this.noteTitle=""}getViewType(){return N}getDisplayText(){return"R Environment"}getIcon(){return"table"}async onOpen(){this.containerEl.empty(),this.render()}async onClose(){}updateEnvironmentData(e,t){this.noteTitle=e,this.environmentData=t,this.render()}render(){this.containerEl.empty();let e=document.createElement("div");e.classList.add("r-environment-content");let t=document.createElement("h5");t.textContent=`R environment for ${this.noteTitle}`,t.classList.add("r-environment-title"),e.appendChild(t);let n=document.createElement("table");n.classList.add("r-environment-table");let o=document.createElement("tr");["Name","Type","Size","Value"].forEach(a=>{let c=document.createElement("th");c.textContent=a,c.classList.add("r-environment-header-cell"),o.appendChild(c)}),n.appendChild(o),this.environmentData.forEach(a=>{let c=document.createElement("tr");c.classList.add("r-environment-row");let p=(v,C="left")=>{let b=document.createElement("td");return b.textContent=v,b.classList.add("r-environment-cell"),C==="right"&&b.classList.add("text-align-right"),b},h=p(a.name);c.appendChild(h);let u=p(Array.isArray(a.type)?a.type.join(", "):a.type);c.appendChild(u);function g(v){let C=["B","KB","MB","GB","TB"];if(v==0)return"0 Byte";let b=Math.floor(Math.log(v)/Math.log(1024));return(v/Math.pow(1024,b)).toFixed(1)+" "+C[b]}let m=p(g(a.size),"right");c.appendChild(m);let y=Array.isArray(a.value)?a.value.slice(0,5).join(", ")+" ...":a.value.toString(),d=p(y);d.classList.add("value-cell"),c.appendChild(d),n.appendChild(c)}),e.appendChild(n),this.containerEl.appendChild(e)}};var xe=require("obsidian"),A="r-help-view",z=class extends xe.ItemView{constructor(e){super(e);this.helpContent=""}getViewType(){return A}getDisplayText(){return"R Help"}getIcon(){return"info"}async onOpen(){this.contentEl.empty(),this.render()}async onClose(){}updateHelpContent(e){this.helpContent=e,this.render()}render(){this.contentEl.empty();let e=document.createElement("div");e.classList.add("r-help-content"),e.innerHTML=this.helpContent,e.querySelectorAll("code").forEach(n=>{n.classList.add("r-help-code")}),this.contentEl.appendChild(e)}};var H=require("obsidian"),ye={rExecutablePath:"",rstudioPandocPath:"",quartoExecutablePath:"",enableFloatingMenu:!0},K=class extends H.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),new H.Setting(e).setName("Path to R Executable").setDesc("Specify the path to your R executable.").addText(t=>t.setPlaceholder("Enter path to R executable").setValue(this.plugin.settings.rExecutablePath).onChange(async n=>{this.plugin.settings.rExecutablePath=n.trim(),await this.plugin.saveSettings()})),new H.Setting(e).setName("Path to RStudio Pandoc").setDesc("Specify the path to your RStudio Pandoc installation.").addText(t=>t.setPlaceholder("Enter path to RStudio Pandoc").setValue(this.plugin.settings.rstudioPandocPath).onChange(async n=>{this.plugin.settings.rstudioPandocPath=n.trim(),await this.plugin.saveSettings()})),new H.Setting(e).setName("Quarto Executable Path").setDesc("Specify the path to your Quarto executable.").addText(t=>t.setPlaceholder("Enter path to Quarto executable").setValue(this.plugin.settings.quartoExecutablePath).onChange(async n=>{this.plugin.settings.quartoExecutablePath=n.trim(),await this.plugin.saveSettings()})),new H.Setting(e).setName("Enable Floating Menu").setDesc("Toggle to show or hide the floating menu in the editor.").addToggle(t=>t.setValue(this.plugin.settings.enableFloatingMenu).onChange(async n=>{this.plugin.settings.enableFloatingMenu=n,await this.plugin.saveSettings(),n?this.plugin.floatingMenu.onLoad():this.plugin.floatingMenu.onUnload()}))}};var T=require("obsidian"),ke=require("crypto"),_=L(require("fs")),I=L(require("path")),Se=require("util"),$e=require("child_process");var ze=(0,Se.promisify)(_.mkdtemp);async function De(s,i,e,t){var h;let n=i.getCursor(),{startLine:o,endLine:r,code:l,existingLabel:a,options:c}=J(i,n.line),p=r;if(l){let u=a||Xe(o),g=(h=e.file)==null?void 0:h.path;if(g){if(!a){let m=Ge(i,o,u);p+=m}try{let{result:m,imagePaths:y,widgetPaths:d,helpContent:v}=await Ze(s,g,l,t,u,be(l),c);if(be(l))new T.Notice("Help content updated in the sidebar.");else{let C=c.include=="false",b=c.output=="false";(m||y.length>0||d.length>0)&&(console.log("trying to generate output"),Pe(i,p,m,y,d,u,c)),(b||C)&&Le(i,u)}}catch(m){console.error("Error executing R code:",m),c.error!=="false"&&c.include!=="false"&&c.output!=="false"?Pe(i,p,`Error:
${m}`,[],[],u,c):Le(i,u)}}else new T.Notice("No file associated with the current view.")}else new T.Notice("No R code chunk found at the cursor position.")}function J(s,i){let e=s.lineCount(),t=i,n=i,o=null,r={};for(;t>=0&&!Ke(s.getLine(t));)t--;if(t<0)return{startLine:-1,endLine:-1,code:"",codeWithAll:"",existingLabel:null,options:{}};for(n=t+1;n<e&&!s.getLine(n).startsWith("```");)n++;if(n>=e)return{startLine:-1,endLine:-1,code:"",codeWithAll:"",existingLabel:null,options:{}};o=Ye(s,t),r=Je(s,t);let l=[],a=[];for(let h=t+1;h<n;h++){let u=s.getLine(h);a.push(u),u.trim().startsWith("#|")||l.push(u)}let c=l.join(`
`),p=a.join(`
`);return{startLine:t,endLine:n,code:c,codeWithAll:p,existingLabel:o,options:r}}function Ke(s){return s=s.trim(),/^```{?r/.test(s)}function Je(s,i){let e={},t=i+1,n=s.lineCount();for(;t<n;){let o=s.getLine(t).trim();if(o.startsWith("#|")){let r=o.match(/^#\|\s*(\w+)\s*:\s*(.*)$/);if(r){let l=r[1],a=r[2];a=a.replace(/^["']|["']$/g,""),e[l]=a}t++}else if(o===""||o.startsWith("#"))t++;else break}return e}function Ye(s,i){let e=i+1,t=s.lineCount();for(;e<t;){let n=s.getLine(e).trim();if(n.startsWith("#|")){let o=n.match(/^#\|\s*(\w+)\s*:\s*(.*)$/);if(o){let r=o[1],l=o[2];if(l=l.replace(/^["']|["']$/g,""),r==="label")return l}e++}else if(n===""||n.startsWith("#"))e++;else break}return null}function Ge(s,i,e){let t=i+1,n=s.lineCount();for(;t<n&&s.getLine(t).trim().startsWith("#|");)t++;return s.replaceRange(`#| label: ${e}
`,{line:t,ch:0}),1}function Xe(s){return(0,ke.createHash)("sha256").update(s.toString()).digest("hex").substring(0,8)}function be(s){return/\?\s*\w+/.test(s)||/help\s*\(\s*\w+\s*\)/.test(s)}async function Ze(s,i,e,t,n,o,r){let l=et(s,i);return new Promise(async(a,c)=>{let p="",h="",u=await ze(I.join(T.Platform.isWin?"C:\\Windows\\Temp\\":"/tmp/","rplots-")),g=T.Platform.isWin?u.replace(/\\/g,"\\\\"):u.replace(/\\/g,"/"),m=I.join(u,`help_${n}.html`),y=m.replace(/\\/g,"/"),d=`__END_OF_OUTPUT__${Date.now()}__`,v="__PLOT_PATH__",C=`__ENVIRONMENT_DATA__${Date.now()}__`,b="__WIDGET_PATH__",He=`
    opts <- list(
      echo = ${r.echo!=="false"?"TRUE":"FALSE"},
      warning = ${r.warning!=="false"?"TRUE":"FALSE"},
      error = ${r.error!=="false"?"TRUE":"FALSE"},
      include = ${r.include!=="false"?"TRUE":"FALSE"},
      output = ${r.output!=="false"?"TRUE":"FALSE"}
    )
    `,le=`
library(evaluate)
library(jsonlite)
library(htmlwidgets)
Sys.setenv(RSTUDIO_PANDOC='${s.settings.rstudioPandocPath}')

${He}

custom_print_htmlwidget <- function(x, ..., viewer = NULL) {
    widgetFileName <- paste0("widget_${n}_",".html")
    widgetFilePath <- file.path("${g}", widgetFileName)
    saveWidget(x, widgetFilePath, selfcontained = TRUE)
    cat("${b}", widgetFileName, "\\n", sep="")
}

environment(custom_print_htmlwidget) <- asNamespace('htmlwidgets')
assignInNamespace("print.htmlwidget", custom_print_htmlwidget, envir = as.environment("package:htmlwidgets"))

timecheck <- Sys.time()

.getHelpFile <- function(file)
{
    path <- dirname(file)
    dirpath <- dirname(path)
    if(!file.exists(dirpath))
        stop(gettextf("invalid %s argument", sQuote("file")), domain = NA)
    pkgname <- basename(dirpath)
    RdDB <- file.path(path, pkgname)
    if(!file.exists(paste(RdDB, "rdx", sep = ".")))
        stop(gettextf("package %s exists but was not installed under R >= 2.10.0 so help cannot be accessed", sQuote(pkgname)), domain = NA)
    tools:::fetchRdDB(RdDB, basename(file))
}
print.help_files_with_topic <- function(x, ...)
{
  browser <- getOption("browser")
  topic <- attr(x, "topic")
  type <- "text"
  paths <- as.character(x)
  
  if(!length(paths)) {
    writeLines(c(gettextf("No documentation for %s in specified packages and libraries:",
                          sQuote(topic)),
                 gettextf("you could try %s",
                          sQuote(paste0("??", topic)))))
    return(invisible(x))
  }
  
  port <- NULL
  
  if(attr(x, "tried_all_packages")) {
    paths <- unique(dirname(dirname(paths)))
    msg <- gettextf("Help for topic %s is not in any loaded package but can be found in the following packages:",
                    sQuote(topic))
    
      writeLines(c(strwrap(msg), "",
                   paste(" ",
                         formatDL(c(gettext("Package"), basename(paths)),
                                  c(gettext("Library"), dirname(paths)),
                                  indent = 22))))
    } else {
    if(length(paths) > 1L) {
      file <- paths[1L]
      p <- paths
      msg <- gettextf("Help on topic %s was found in the following packages:",
                      sQuote(topic))
      paths <- dirname(dirname(paths))
      txt <- formatDL(c("Package", basename(paths)),
                      c("Library", dirname(paths)),
                      indent = 22L)
      writeLines(c(strwrap(msg), "", paste(" ", txt), ""))
      if(interactive()) {
        fp <- file.path(paths, "Meta", "Rd.rds")
        tp <- basename(p)
        titles <- tp
        if(type == "html" || type == "latex")
          tp <- tools::file_path_sans_ext(tp)
        for (i in seq_along(fp)) {
          tmp <- try(readRDS(fp[i]))
          titles[i] <- if(inherits(tmp, "try-error"))
            "unknown title" else
              tmp[tools::file_path_sans_ext(tmp$File) == tp[i], "Title"]
        }
        txt <- paste0(titles, " {", basename(paths), "}")
        ## the default on menu() is currtently graphics = FALSE
        res <- menu(txt, title = gettext("Choose one"),
                    graphics = getOption("menu.graphics"))
        if(res > 0) file <- p[res]
      } else {
        writeLines(gettext("
Using the first match ..."))
      }
    }
    else
      file <- paths
    
    if(type == "text") {
      pkgname <- basename(dirname(dirname(file)))
      tools::Rd2HTML(.getHelpFile(file), out = "${y}",
                            package = pkgname)

    }
    
  }
  
  invisible(x)
}

if (!exists("user_env")) {
  user_env <- new.env()
}

results <- evaluate(${JSON.stringify(e)}, envir = user_env)

outputs <- character()
imagePaths <- character()

for (res in results) {
  if (inherits(res, "source")) {
  } else if (inherits(res, "warning")) {
    if (opts$warning && opts$include) {
      outputs <- c(outputs, paste("Warning:", conditionMessage(res)))
    }
  } else if (inherits(res, "message")) {
    if (opts$output && opts$include) {
      outputs <- c(outputs, res$message)
    }
  } else if (inherits(res, "error")) {
    if (opts$error && opts$include) {
      outputs <- c(outputs, paste("Error:", conditionMessage(res)))
    }
  } else if (inherits(res, "character")) {
    if (opts$output && opts$include) {
      outputs <- c(outputs, res)
    }
  } else if (inherits(res, "recordedplot")) {
    if (opts$output && opts$include) {
      timestamp <- format(Sys.time(), "%Y%m%d%H%M%S")
      plotFileName <- paste0("plot_${n}_", length(imagePaths) + 1, "_", timestamp, ".jpg")
      plotFilePath <- file.path("${g}", plotFileName)
      jpeg(filename=plotFilePath, width=800, height=600)
      replayPlot(res)
      dev.off()
      imagePaths <- c(imagePaths, plotFileName)
    }
  }
}

if (opts$output && opts$include) {
  if (requireNamespace("gganimate", quietly = TRUE)) {
    anim <- try(gganimate::last_animation(), silent = TRUE)
    if (is.character(anim[1])) {
      if (file.info(anim[1])$mtime > timecheck) {
        timestamp <- format(Sys.time(), "%Y%m%d%H%M%S")
        animFileName <- paste0("animation_${n}_", timestamp, ".gif")
        animFilePath <- file.path("${g}", animFileName)
        file.copy(anim[1], animFilePath)
        imagePaths <- c(imagePaths, animFileName)
      }
    }
  }
}

if (opts$output && opts$include && length(outputs) > 0) {
  cat(paste(outputs, collapse = "\\n"), "\\n")
}

if (opts$output && opts$include) {
  for (img in imagePaths) {
    cat("${v}", img, "\\n", sep="")
  }
}

vars <- ls(envir = user_env)
env_list <- lapply(vars, function(var_name) {
  var_value <- get(var_name, envir = user_env)
  var_class <- class(var_value)
  var_size <- as.numeric(object.size(var_value))
  var_val <- capture.output(str(var_value, max.level=0))

  list(
    name = var_name,
    type = var_class,
    size = var_size,
    value = var_val
  )
})

env_json <- toJSON(env_list, auto_unbox = TRUE)
cat("${C}\\n")
cat(env_json)
cat("\\n${d}\\n")
    `,ce=async Z=>{var ue,he;let ee=Z.toString();if(p+=ee,p.includes(d)){l.stdout.off("data",ce),l.stderr.off("data",pe);let S="",M="";if(o){try{_.existsSync(m)?M=await _.promises.readFile(m,"utf8"):(console.error("Help file does not exist:",m),M="Failed to retrieve help content.")}catch($){console.error("Error reading help content:",$),M="Failed to retrieve help content."}let f=(ue=s.app.workspace.getLeavesOfType(A)[0])==null?void 0:ue.view;f&&f.updateHelpContent(M)}let de="";if(p.includes(C)){let f=p.split(C);S=f[0].trim(),de=f[1].split(d)[0].trim()}else S=p.split(d)[0].trim();let ge=v.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),B=[],Ie=new RegExp(`${ge}(.*)`,"g"),te;for(;(te=Ie.exec(S))!==null;)if(te[1]){let f=te[1].trim();B.push(f)}S=S.replace(new RegExp(`${ge}.*`,"g"),"").trim();for(let f of B){let $=I.join(u,f);try{let D=await _.promises.readFile($),F=`plots/${f}`;s.app.vault.getAbstractFileByPath("plots")||await s.app.vault.createFolder("plots");let ie=s.app.vault.getAbstractFileByPath(F);ie?await s.app.vault.modifyBinary(ie,D):await s.app.vault.createBinary(F,D),B[B.indexOf(f)]=F}catch(D){console.error(`Error handling image file ${f}:`,D)}}let W=[],me=b.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),Me=new RegExp(`${me}(.*)`,"g"),ne;for(;(ne=Me.exec(S))!==null;)if(ne[1]){let f=ne[1].trim();W.push(f)}S=S.replace(new RegExp(`${me}.*`,"g"),"").trim();for(let f of W){let $=I.join(u,f);try{let D=await _.promises.readFile($,"utf8"),F=`widgets/${f}`,ve=s.app.vault.adapter.getBasePath();s.app.vault.getAbstractFileByPath("widgets")||await s.app.vault.createFolder("widgets");let we=s.app.vault.getAbstractFileByPath(F);we?await s.app.vault.modify(we,D):await s.app.vault.create(F,D);let Be="file://"+I.join(ve,F);W[W.indexOf(f)]=Be}catch(D){console.error(`Error handling widget file ${f}:`,D)}}try{}catch(f){console.error(`Error removing temporary directory ${u}:`,f)}let fe=(he=s.app.workspace.getLeavesOfType(N)[0])==null?void 0:he.view;if(fe){let f=[];try{f=JSON.parse(de)}catch($){console.error("Failed to parse environment data JSON:",$)}fe.updateEnvironmentData(t,f)}p="",h="",h?c(h.trim()):a({result:S,imagePaths:B,widgetPaths:W,helpContent:M})}},pe=Z=>{let ee=Z.toString();h+=ee};l.stdout.on("data",ce),l.stderr.on("data",pe),console.log("sending the following code to R process:",le),l.stdin.write(le+`
`)})}function et(s,i){let e=s.rProcesses.get(i);return e||(e=tt(s,i)),e}function tt(s,i){let e=s.settings.rExecutablePath.trim()||"/usr/local/bin/R";if(!e)throw new T.Notice("R executable path is not set. Please update the path in settings."),new Error("R executable path is not set.");if(!_.existsSync(e))throw new T.Notice(`R executable not found at ${e}. Please update the path in settings.`),new Error(`R executable not found at ${e}.`);let t={...process.env},n=(0,$e.spawn)(e,["--vanilla","--quiet","--slave"],{stdio:"pipe",env:t});n.on("error",r=>{console.error(`Failed to start R process for ${i}:`,r)});let o=`
library(jsonlite)
if (!exists("user_env")) {
  user_env <- new.env()
}
options(browser='false')
options(bitmapType = 'cairo')
options(device = function(...) jpeg(filename = tempfile(), width=800, height=600, ...))
  `;return n.stdin.write(o+`
`),s.rProcesses.set(i,n),n}function nt(s){return s.replace(/([\\`*_{}[\]()#+\-!>|])/g,"\u200B$1")}function Pe(s,i,e,t,n,o,r,l=!1){let a=[],c=[];if(e&&e.trim()!==""){let v=nt(e.trim()).split(`
`).map(C=>"> "+C);a.push(...v)}if(t.forEach(d=>{let C=`![center|480](${`${d}`})`;c.push(`> ${C}`)}),n.forEach(d=>{let v=`<iframe src="${d}" width="100%" height="680px"></iframe>`;c.push(`> ${v}`)}),a.length===0&&c.length===0)return;let p=l?"ERROR":"OUTPUT",u=`${`> [!${p}]+ {#output-${o}}`}
`;a.length!==0&&(u+="> ```\n",u+=a.join(`
`)+`
`,u+="> ```\n"),c.length!==0&&(u+=c.join(`
`)+`
`,u+=`> 
`);let g=-1,m=-1,y=s.lineCount();for(let d=0;d<y;d++){let v=s.getLine(d);if(v.trim().startsWith(`> [!${p}]`)&&v.includes(`{#output-${o}}`)){for(g=d,m=d;m+1<y;){let C=s.getLine(m+1);if(C.trim()===""||C.startsWith("> "))m++;else break}break}}if(g!==-1&&m!==-1){let d={line:g,ch:0},v={line:m+1,ch:0};s.replaceRange(u+`
`,d,v)}else{let d={line:i+1,ch:0};s.replaceRange(`
`+u+`
`,d)}}function Le(s,i){let e=-1,t=-1,n=s.lineCount();for(let o=0;o<n;o++)if(s.getLine(o).trim()===`> [!OUTPUT]+ {#output-${i}}`){for(e=o,t=o;t+1<n;){let l=s.getLine(t+1);if(!l.startsWith("> ")&&l.trim()!=="")break;t++}break}if(e!==-1&&t!==-1){let o={line:e,ch:0},r={line:t+1,ch:0};s.replaceRange("",o,r)}}var w=require("obsidian"),k=L(require("fs")),E=L(require("path")),Te=require("child_process");async function _e(s){let i=s.app.workspace.getActiveFile();if(!i){new w.Notice("No active note to export.");return}try{let t=await s.app.vault.read(i);t=it(t,i),t=st(t),t=ot(t);let{content:n,imagePaths:o}=ct(t);t=n;let r=await rt(s,t,i.path),l=E.dirname(r);await pt(s,o,l),await lt(s,r),new w.Notice("Note exported and rendered with Quarto successfully.")}catch(e){console.error("Failed to export note with Quarto:",e),new w.Notice("Failed to export note with Quarto.")}}function it(s,i){return s.startsWith(`---
`)?s:`---
title: "${i.basename}"
author: "Author Name"
date: today
format: html
---

`+s}function st(s){let i=/> \[!OUTPUT\]\+ {#output-[\w]+}\n(?:>.*\n)*>/gm;return s.replace(i,"")}function ot(s){let i=/^```r$/gim;return s.replace(i,"```{r}")}async function rt(s,i,e){let t=E.basename(e,".md"),n=at(t),o=`${n}_quarto.qmd`,r,l=s.app.vault.adapter;if(l instanceof w.FileSystemAdapter)r=l.getBasePath();else throw new w.Notice("Unable to determine vault base path. Export failed."),new Error("Vault adapter is not a FileSystemAdapter.");let a=E.join(r,"exports"),c=E.join(a,n);if(!k.existsSync(a))try{k.mkdirSync(a)}catch(h){throw new w.Notice("Failed to create exports folder. Export failed."),h}if(!k.existsSync(c))try{k.mkdirSync(c)}catch(h){throw new w.Notice("Failed to create base export folder. Export failed."),h}let p=E.join(c,o);try{await k.promises.writeFile(p,i,"utf8"),new w.Notice(`Exported to ${p}`)}catch(h){throw new w.Notice("Failed to write export file. Export failed."),h}return p}function at(s){return s.replace(/[^a-zA-Z0-9-_]/g,"_")}async function lt(s,i){return new Promise((e,t)=>{let n=s.settings.quartoExecutablePath||"quarto";if(!k.existsSync(n)){new w.Notice(`Quarto executable not found at ${n}. Please update the path in settings.`),t(new Error(`Quarto executable not found at ${n}.`));return}let o=s.settings.rExecutablePath||"Rscript",r={...process.env};r.QUARTO_R=o;let l=E.dirname(o);r.PATH=`${l}${E.delimiter}${r.PATH}`;let a=(0,Te.spawn)(n,["render",i],{stdio:["ignore","pipe","pipe"],env:r}),c="";a.stderr.on("data",p=>{c+=p.toString()}),a.on("error",p=>{new w.Notice("Failed to start Quarto rendering process."),t(p)}),a.on("exit",(p,h)=>{p===0?(new w.Notice("Quarto rendering completed successfully."),e()):(console.error(`Quarto stderr: ${c}`),new w.Notice("Quarto rendering failed. Click for details.",1e4),t(new Error(`Quarto exited with code ${p}`)))})})}function ct(s){let i=/!\[\[([^\]]+)\]\]/g,e=new Set;return{content:s.replace(i,(n,o)=>{let[r,l]=o.split("|"),a=E.basename(r);return e.add(r.trim()),`![${l?l.trim():a}](${a})`}),imagePaths:e}}async function pt(s,i,e){let t=s.app.vault.adapter;if(!(t instanceof w.FileSystemAdapter))throw new Error("Vault adapter is not a FileSystemAdapter.");let n=t.getBasePath();for(let o of i){let r=E.join(n,o),l=E.basename(o),a=E.join(e,l);try{await k.promises.copyFile(r,a)}catch(c){console.error(`Failed to copy image ${o} to ${a}:`,c),new w.Notice(`Failed to copy image ${o}.`)}}}var O=require("obsidian"),Re=require("child_process"),P=L(require("process")),V=L(require("fs")),se=L(require("path"));function Fe(){if(P.env.PATH=ut(),O.Platform.isMacOS)P.env.PATH+=":/usr/local/bin:/opt/homebrew/bin";else if(O.Platform.isLinux)P.env.PATH+=":/usr/local/bin";else if(O.Platform.isWin){let t=function(o){try{let r=se.join(o,"R");if(V.existsSync(r)){let l=V.readdirSync(r);l=l.filter(a=>/^R-\d+\.\d+\.\d+$/.test(a)),l.sort((a,c)=>{var u,g;let p=(u=a.match(/R-(\d+\.\d+\.\d+)/))==null?void 0:u[1],h=(g=c.match(/R-(\d+\.\d+\.\d+)/))==null?void 0:g[1];return p&&h?n(h,p):0}),l.forEach(a=>{let c=se.join(r,a,"bin");V.existsSync(c)&&e.push(c)})}}catch(r){console.error(`Error accessing ${o}:`,r)}},n=function(o,r){let l=o.split(".").map(Number),a=r.split(".").map(Number);for(let c=0;c<l.length;c++){if(l[c]>a[c])return 1;if(l[c]<a[c])return-1}return 0},s=P.env.ProgramFiles||"C:\\Program Files",i=P.env["ProgramFiles(x86)"]||"C:\\Program Files (x86)",e=[];t(s),t(i),e.forEach(o=>{P.env.PATH=`${o};${P.env.PATH}`})}}function ut(){if(O.Platform.isWin)return P.env.PATH||"";try{let s=P.env.SHELL||"/bin/bash";return(0,Re.execSync)("echo $PATH",{shell:s}).toString().trim()}catch(s){return console.error("Could not retrieve PATH from user's shell:",s),P.env.PATH||""}}var Ne=require("child_process"),Y=class{constructor(i,e,t){this.process=null;this._buffer="";this._requestId=1;this._responseHandlers=new Map;this.rExecutablePath=i,this.onCompletion=e,this.onHover=t}start(){this.process=(0,Ne.spawn)(this.rExecutablePath,["--slave","-e","languageserver::run()"]),this._buffer="",this.process.stdout.on("data",i=>{this._buffer+=i.toString(),this.parseMessages()}),this.initialize()}stop(){this.process&&(this.process.kill(),this.process=null)}initialize(){let i={processId:process.pid,rootUri:null,capabilities:{}};this.sendRequest("initialize",i,e=>{this.sendNotification("initialized",{})})}sendRequest(i,e,t){if(this.process){let n=this.nextRequestId(),o={jsonrpc:"2.0",id:n,method:i,params:e};t&&this._responseHandlers.set(n,t);let r=JSON.stringify(o),a=`Content-Length: ${Buffer.byteLength(r,"utf8")}\r
\r
${r}`;this.process.stdin.write(a)}}sendNotification(i,e){if(this.process){let n=JSON.stringify({jsonrpc:"2.0",method:i,params:e}),r=`Content-Length: ${Buffer.byteLength(n,"utf8")}\r
\r
${n}`;this.process.stdin.write(r)}}sendSignatureHelpRequest(i,e,t){this.sendRequest("textDocument/signatureHelp",{textDocument:{uri:i},position:e},t)}parseMessages(){for(;;){let i=this._buffer.indexOf(`\r
\r
`);if(i===-1)return;let e=this._buffer.slice(0,i),t=this._buffer.slice(i+4),n=e.split(`\r
`),o=0;for(let l of n){let[a,c]=l.split(": ");a.toLowerCase()==="content-length"&&(o=parseInt(c,10))}if(t.length<o)return;let r=t.slice(0,o);this._buffer=t.slice(o),this.handleMessage(r)}}handleMessage(i){try{let e=JSON.parse(i);if(e.id!==void 0){let t=this._responseHandlers.get(e.id);t&&(t(e),this._responseHandlers.delete(e.id))}else e.method}catch(e){console.error("Failed to parse language server response:",e,"Message:",i)}}nextRequestId(){return this._requestId++}};var G=class{constructor(i,e,t,n){this.selectedIndex=-1;this.handleDocumentClick=i=>{this.containerEl.contains(i.target)||this.close()};this.handleKeyDown=i=>{["Escape"].includes(i.key)&&(i.preventDefault(),this.close())};this.app=i,this.editor=e,this.signatures=t,this.onClose=n,this.createDropdown()}createDropdown(){this.containerEl=createEl("div",{cls:"signature-help-dropdown"}),this.signatures.forEach((i,e)=>{let t=this.containerEl.createDiv({cls:"signature-label"});t.textContent=i.label;let n=this.containerEl.createDiv({cls:"signature-value"});n.textContent=this.extractDocumentation(i.documentation)}),this.positionDropdown(),document.body.appendChild(this.containerEl),this.addEventListeners()}extractDocumentation(i){return i?typeof i=="string"?i:"value"in i?i.value:"":""}positionDropdown(){let i=this.editor.coordsAtPos(this.editor.getCursor());i?(this.containerEl.style.left=`${i.left}px`,this.containerEl.style.top=`${i.bottom+5}px`):(this.containerEl.style.left="100px",this.containerEl.style.top="100px")}addEventListeners(){document.addEventListener("click",this.handleDocumentClick),document.addEventListener("keydown",this.handleKeyDown,!0)}removeEventListeners(){document.removeEventListener("click",this.handleDocumentClick),document.removeEventListener("keydown",this.handleKeyDown,!0)}updateContent(i){this.signatures=i,this.containerEl.empty(),this.signatures.forEach((e,t)=>{let n=this.containerEl.createDiv({cls:"signature-label"});n.textContent=e.label;let o=this.containerEl.createDiv({cls:"signature-value"});o.textContent=this.extractDocumentation(e.documentation)}),this.positionDropdown()}close(){this.removeEventListeners(),this.containerEl&&this.containerEl.parentElement&&this.containerEl.parentElement.removeChild(this.containerEl),this.onClose()}};var X=class{constructor(i,e,t,n){this.selectedIndex=-1;this.handleDocumentClick=i=>{this.containerEl.contains(i.target)||this.close()};this.handleKeyDown=i=>{switch(["ArrowDown","ArrowUp","Escape","Enter"].includes(i.key)&&(i.preventDefault(),i.stopPropagation()),i.key){case"ArrowDown":this.moveSelection(1);break;case"ArrowUp":this.moveSelection(-1);break;case"Escape":this.close();break;case"Enter":if(this.selectedIndex>=0&&this.selectedIndex<this.completions.length){let e=this.completions[this.selectedIndex];this.onSelect(e),this.close(),this.editor.focus()}break}};this.app=i,this.editor=e,this.completions=t,this.onSelect=n,this.createDropdown()}createDropdown(){this.containerEl=createEl("div",{cls:"completion-dropdown"}),this.containerEl.style.position="absolute",this.containerEl.style.zIndex="1000",this.containerEl.style.backgroundColor="var(--background-primary)",this.containerEl.style.border="1px solid var(--background-modifier-border)",this.containerEl.style.borderRadius="4px",this.containerEl.style.maxHeight="200px",this.containerEl.style.overflowY="auto",this.completions.forEach((i,e)=>{let t=this.containerEl.createDiv({cls:"completion-item"});t.textContent=i.label,t.addEventListener("click",()=>{this.onSelect(i),this.close()}),t.addEventListener("mouseenter",()=>{this.highlightItem(e)})}),this.positionDropdown(),document.body.appendChild(this.containerEl),this.addEventListeners()}positionDropdown(){let i=this.editor.coordsAtPos(this.editor.getCursor());i?(this.containerEl.style.left=`${i.left}px`,this.containerEl.style.top=`${i.bottom}px`):(this.containerEl.style.left="100px",this.containerEl.style.top="100px")}addEventListeners(){document.addEventListener("click",this.handleDocumentClick),document.addEventListener("keydown",this.handleKeyDown,!0)}removeEventListeners(){document.removeEventListener("click",this.handleDocumentClick),document.removeEventListener("keydown",this.handleKeyDown,!0)}moveSelection(i){let e=this.containerEl.querySelectorAll(".completion-item");e.length!==0&&(this.selectedIndex>=0&&this.selectedIndex<e.length&&e[this.selectedIndex].removeClass("is-selected"),this.selectedIndex+=i,this.selectedIndex<0&&(this.selectedIndex=e.length-1),this.selectedIndex>=e.length&&(this.selectedIndex=0),e[this.selectedIndex].addClass("is-selected"),e[this.selectedIndex].scrollIntoView({block:"nearest"}))}highlightItem(i){this.containerEl.querySelectorAll(".completion-item").forEach((t,n)=>{n===i?(t.addClass("is-selected"),this.selectedIndex=i):t.removeClass("is-selected")})}close(){this.removeEventListeners(),this.containerEl&&this.containerEl.parentElement&&this.containerEl.parentElement.removeChild(this.containerEl),this.editor.focus()}};var Ae=require("@codemirror/view"),U=class extends x.Plugin{constructor(){super(...arguments);this.rProcesses=new Map;this._documentId=1;this.isInsertingCompletion=!1;this.currentCompletions=[];this.currentDropdown=null;this.signatureHelpDropdown=null;this.completionSource=e=>{if(console.log("completionSource called, context:",e),this.currentCompletions.length===0)return null;let t=e.matchBefore(/\w*/);return!t||t.from===t.to&&e.explicit===!1?null:{from:t.from,to:e.pos,options:this.currentCompletions}}}async onload(){console.log("Loading Combined Plugin"),document.body.setAttribute("ridian","true"),await this.loadSettings(),Fe(),this.floatingMenu=new q(this),this.settings.enableFloatingMenu&&this.floatingMenu.onLoad(),this.addSettingTab(new K(this.app,this)),this.registerView(N,t=>new Q(t)),this.registerView(A,t=>new z(t)),this.app.workspace.onLayoutReady(()=>{this.initializeViews()}),this.registerCommands();let e=this.settings.rExecutablePath.trim()||"/usr/local/bin/R";this.rLanguageServer=new Y(e,this.handleCompletion.bind(this),this.handleHover.bind(this)),this.rLanguageServer.start(),this.registerEditorEvents(),console.log("Combined Plugin loaded successfully")}onunload(){console.log("Unloading Combined Plugin"),document.body.removeAttribute("ridian"),this.floatingMenu.onUnload(),this.rLanguageServer.stop(),console.log("Combined Plugin unloaded successfully")}async loadSettings(){this.settings=Object.assign({},ye,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}initializeViews(){if(this.app.workspace.getLeavesOfType(N).length===0){let e=this.app.workspace.getRightLeaf(!1);e&&e.setViewState({type:N,active:!0})}if(this.app.workspace.getLeavesOfType(A).length===0){let e=this.app.workspace.getRightLeaf(!0);e&&e.setViewState({type:A,active:!0})}}registerCommands(){this.addCommand({id:"run-current-code-chunk",name:"Run Current Code Chunk",editorCallback:(e,t)=>{if(!(t instanceof x.MarkdownView)){new x.Notice("Current view is not a markdown view.");return}if(!t.file){new x.Notice("No file associated with the current view.");return}let n=t.file.basename;De(this,e,t,n)},hotkeys:[{modifiers:["Mod"],key:"r"}]}),this.addCommand({id:"export-note-with-quarto",name:"Export Note with Quarto",callback:()=>_e(this)})}registerEditorEvents(){this.registerEditorExtension(Ae.EditorView.updateListener.of(e=>{let t=this.app.workspace.getActiveViewOfType(x.MarkdownView);if(!t||!t.editor)return;let n=t.editor;e.selectionSet&&this.handleCursorActivity(n)}))}nextDocumentId(){return this._documentId++}handleCompletion(e){if(e.length===0){this.currentDropdown&&(console.log("No completions available. Closing existing dropdown."),this.currentDropdown.close(),this.currentDropdown=null);return}let t=e.map(r=>{var h,u;let l=r.label||"",a=((h=r.textEdit)==null?void 0:h.newText)||r.insertText||l,c=r.detail||"",p=typeof r.documentation=="string"?r.documentation:((u=r.documentation)==null?void 0:u.value)||void 0;return{label:l,insertText:a,detail:c,info:p}});this.currentCompletions=t;let n=this.app.workspace.getActiveViewOfType(x.MarkdownView);if(!n)return;let o=n.editor;this.showCompletionDropdown(o)}handleHover(e){console.log("Hover contents:",e)}showCompletionDropdown(e){!this.currentCompletions||this.currentCompletions.length===0||(this.currentDropdown&&this.currentDropdown.close(),this.currentDropdown=new X(this.app,e,this.currentCompletions,t=>{let n=t.insertText||t.label;this.insertCompletionAtCursor(e,n),this.currentDropdown&&(this.currentDropdown.close(),this.currentDropdown=null)}))}insertCompletionAtCursor(e,t){var p,h;this.isInsertingCompletion=!0;let n=e.getCursor(),o=e.getLine(n.line),r=((p=o.slice(0,n.ch).match(/[\w.]*$/))==null?void 0:p[0])||"",l=((h=o.slice(n.ch).match(/^[\w.]*/))==null?void 0:h[0])||"",a={line:n.line,ch:n.ch-r.length},c={line:n.line,ch:n.ch+l.length};e.replaceRange(t,a,c),e.setCursor({line:n.line,ch:a.ch+t.length}),this.isInsertingCompletion=!1}handleCursorActivity(e){if(this.isInsertingCompletion)return;let t=e.getCursor();e.getLine(t.line).slice(0,t.ch).match(/(\w+)\([^)]*$/)?(this.currentDropdown&&(-this.currentDropdown.close(),this.currentDropdown=null),this.showSignatureHelp(e,t)):(this.signatureHelpDropdown&&(-this.signatureHelpDropdown.close(),this.signatureHelpDropdown=null),this.showCompletion(e,t))}showSignatureHelp(e,t){let{codeWithAll:n,startLine:o}=J(e,t.line);if(!n){this.closeSignatureHelpDropdown();return}let r=re.tmpdir(),l=`obsidian-virtual-document-${this.nextDocumentId()}.r`,a=ae.join(r,l);oe.writeFileSync(a,n);let c=`file://${a.replace(/\\/g,"/")}`,p="r",h=1,u={line:t.line-(o+1),character:t.ch};this.rLanguageServer.sendNotification("textDocument/didOpen",{textDocument:{uri:c,languageId:p,version:h,text:n}}),this.rLanguageServer.sendSignatureHelpRequest(c,u,g=>{g.result?this.handleSignatureHelp(g.result):(console.error("Unexpected signatureHelp response:",g),this.closeSignatureHelpDropdown())})}showCompletion(e,t){let{codeWithAll:n,startLine:o}=J(e,t.line);if(!n){this.currentDropdown&&(this.currentDropdown.close(),this.currentDropdown=null);return}let r=re.tmpdir(),l=`obsidian-virtual-document-${this.nextDocumentId()}.r`,a=ae.join(r,l);oe.writeFileSync(a,n);let c=`file://${a.replace(/\\/g,"/")}`,p="r",h=1,u={line:t.line-(o+1),character:t.ch};this.rLanguageServer.sendNotification("textDocument/didOpen",{textDocument:{uri:c,languageId:p,version:h,text:n}}),this.rLanguageServer.sendRequest("textDocument/completion",{textDocument:{uri:c},position:u,context:{triggerKind:1}},g=>{g.result&&g.result.items?this.handleCompletion(g.result.items):console.error("Unexpected completion response:",g)})}handleSignatureHelp(e){if(!e||!e.signatures||e.signatures.length===0){this.closeSignatureHelpDropdown();return}let t=this.app.workspace.getActiveViewOfType(x.MarkdownView);if(!t)return;let n=t.editor;this.signatureHelpDropdown?this.signatureHelpDropdown.updateContent(e.signatures):this.signatureHelpDropdown=new G(this.app,n,e.signatures,()=>{this.signatureHelpDropdown=null})}closeSignatureHelpDropdown(){this.signatureHelpDropdown&&(this.signatureHelpDropdown.close(),this.signatureHelpDropdown=null)}applyWrapping(e){let t=this.app.workspace.getActiveViewOfType(x.MarkdownView);if(!t)return;let n=t.editor,o=n.getSelection();if(o){n.replaceSelection(`${e}${o}${e}`);let r=n.getCursor(),l={line:r.line,ch:r.ch-o.length-e.length},a={line:r.line,ch:r.ch-e.length};n.setSelection(l,a)}else{let r=n.getCursor();n.replaceRange(`${e}${e}`,r);let l={line:r.line,ch:r.ch+e.length};n.setSelection(l,l)}n.focus()}applyHtmlTag(e){let t=this.app.workspace.getActiveViewOfType(x.MarkdownView);if(!t)return;let n=t.editor,o=n.getSelection(),r=`<${e}>`,l=`</${e}>`;if(o){n.replaceSelection(`${r}${o}${l}`);let a=n.getCursor(),c=a.ch-l.length;n.setCursor({line:a.line,ch:c})}else{n.replaceRange(`${r}${l}`,n.getCursor());let a=n.getCursor();n.setCursor({line:a.line,ch:a.ch-l.length})}n.focus()}applyHeading(e){let t=this.app.workspace.getActiveViewOfType(x.MarkdownView);if(!t)return;let n=t.editor,o=n.getCursor(),r=n.getLine(o.line),l="#".repeat(e)+" ";if(r.startsWith("#")){let c=r.replace(/^#+\s*/,"");n.replaceRange(l+c,{line:o.line,ch:0},{line:o.line,ch:r.length})}else n.replaceRange(l,{line:o.line,ch:0});let a=l.length;n.setCursor({line:o.line,ch:a}),n.focus()}insertCodeBlock(e){let t=this.app.workspace.getActiveViewOfType(x.MarkdownView);if(!t)return;let n=t.editor,o=n.getCursor(),r=`\`\`\`${e}
`,l="\n```\n";n.replaceRange(r,o),n.replaceRange(l,{line:o.line,ch:o.ch+r.length});let a={line:o.line+1,ch:0};n.setSelection(a,a),n.focus()}applyAlignment(e){let t=this.app.workspace.getActiveViewOfType(x.MarkdownView);if(!t)return;let n=t.editor,o=n.getSelection(),r=`<div style="text-align: ${e};">`,l="</div>";if(o){n.replaceSelection(`${r}
${o}
${l}`);let a=n.getCursor();n.setCursor({line:a.line+1,ch:0})}else{n.replaceRange(`${r}

${l}`,n.getCursor());let a=n.getCursor();n.setCursor({line:a.line-1,ch:r.length+1})}n.focus()}runCommand(e){let t=`ridian:${e}`;this.app.commands.executeCommandById(t)}};var ht=U;

/* nosourcemap */